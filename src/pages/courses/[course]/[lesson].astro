---
import type { CollectionEntry } from 'astro:content';
import { getEntry, render } from 'astro:content';
import DefaultLayout from '@/layouts/DefaultLayout.astro';

import {
  createLessonMap,
  findAdjacentLessons,
  getCourseLessons,
  getLessonPaths,
  organizeLessonsIntoSections,
  readCourseMeta,
} from '@/lib/courses';
import { extractHeadingsFromLesson } from '@/lib/extractHeadings';

import LessonLayout from '@/components/courses/LessonLayout';

export async function getStaticPaths() {
  return await getLessonPaths();
}

const { courseSlug, lessonSlug } = Astro.props;

const course: CollectionEntry<'courses'> | undefined = await getEntry(
  'courses',
  courseSlug,
);

if (!course) {
  throw Astro.redirect('/404');
}

const lessonId = `${courseSlug}/${lessonSlug}`;
const lesson: CollectionEntry<'lessons'> | undefined = await getEntry(
  'lessons',
  lessonId,
);

if (!lesson) {
  throw Astro.redirect('/404');
}

// Read meta.json to get course structure
const courseStructure = readCourseMeta(courseSlug);

// Get all lessons for this course
const allLessons = await getCourseLessons(courseSlug);

// Create a map of lesson slugs to lesson entries
const lessonMap = createLessonMap(allLessons);

// Organize lessons according to meta.json structure
const sections = organizeLessonsIntoSections(courseStructure, lessonMap);

const { prevLesson, nextLesson } = courseStructure
  ? findAdjacentLessons(courseStructure, lessonSlug)
  : { prevLesson: null, nextLesson: null };

// Extract headings from the lesson content at build time
const headings = await extractHeadingsFromLesson(courseSlug, lessonSlug);

const { Content } = await render(lesson);

const pageTitle = `${lesson.data.title} - ${course.data.title}`;
const pageDescription = lesson.data.description || lesson.data.title;
---

<DefaultLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <LessonLayout
    course={course}
    lesson={lesson}
    courseSlug={courseSlug}
    prevLesson={prevLesson}
    nextLesson={nextLesson}
    sections={sections}
    currentLessonSlug={lessonSlug}
    headings={headings}
    client:load
  >
    <Content />
  </LessonLayout>
</DefaultLayout>
