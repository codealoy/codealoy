---
import { getCollection, getEntry, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import DefaultLayout from '@/layouts/DefaultLayout.astro';

import {
  extractCourseSlug,
  findAdjacentLessons,
  isValidLessonPage,
  readCourseMeta,
} from '@/lib/courses';

import LessonLayout from '@/components/courses/LessonLayout';

export async function getStaticPaths() {
  const courses = await getCollection('courses', ({ data }) => {
    return data.status === 'published';
  });

  const paths = [];

  for (const course of courses) {
    const courseSlug = extractCourseSlug(course.id);
    const courseStructure = readCourseMeta(courseSlug);

    if (courseStructure?.pages) {
      for (const page of courseStructure.pages) {
        if (isValidLessonPage(page)) {
          paths.push({
            params: { course: courseSlug, lesson: page },
            props: { courseSlug, lessonSlug: page },
          });
        }
      }
    }
  }

  return paths;
}

const { courseSlug, lessonSlug } = Astro.props;

const course: CollectionEntry<'courses'> | undefined = await getEntry(
  'courses',
  courseSlug,
);

if (!course) {
  throw Astro.redirect('/404');
}

const lessonId = `${courseSlug}/${lessonSlug}`;
const lesson: CollectionEntry<'lessons'> | undefined = await getEntry(
  'lessons',
  lessonId,
);

if (!lesson) {
  throw Astro.redirect('/404');
}

const courseStructure = readCourseMeta(courseSlug);
const { prevLesson, nextLesson } = courseStructure
  ? findAdjacentLessons(courseStructure, lessonSlug)
  : { prevLesson: null, nextLesson: null };

const { Content } = await render(lesson);

const pageTitle = `${lesson.data.title} - ${course.data.title}`;
const pageDescription = lesson.data.description || lesson.data.title;
---

<DefaultLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <LessonLayout
    course={course}
    lesson={lesson}
    courseSlug={courseSlug}
    prevLesson={prevLesson}
    nextLesson={nextLesson}
  >
    <div
      class="prose prose-base lg:prose-lg dark:prose-invert prose-a:text-primary prose-a:no-underline prose-img:rounded-lg max-w-none"
    >
      <Content />
    </div>
  </LessonLayout>
</DefaultLayout>
