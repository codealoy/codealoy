---
import { getCollection, getEntry } from 'astro:content';
import DefaultLayout from '@/layouts/DefaultLayout.astro';

import { getCoursePaths } from '@/lib/courses';
import type { CourseMeta, LessonSection } from '@/lib/types/course';

import CourseOverview from '@/components/courses/CourseOverview';

// Preload all meta.json files using import.meta.glob
const metaFiles = import.meta.glob('../../../content/courses/**/meta.json', {
  eager: true,
});

export async function getStaticPaths() {
  return await getCoursePaths();
}

const { courseSlug } = Astro.props;

// Use the course slug directly as the course ID
const course = await getEntry('courses', courseSlug);

if (!course) {
  throw Astro.redirect('/404');
}

// Read meta.json to get course structure
// Find the matching file in the glob results
const matchingPath = Object.keys(metaFiles).find((path) =>
  path.includes(`${courseSlug}/meta.json`),
);

let courseStructure: CourseMeta | undefined = undefined;

if (matchingPath && metaFiles[matchingPath]) {
  try {
    courseStructure = metaFiles[matchingPath] as CourseMeta;
  } catch (error) {
    console.error(`Failed to parse meta.json for course ${courseSlug}:`, error);
  }
} else {
  console.error(
    `Failed to find meta.json for course ${courseSlug}. Available paths:`,
    Object.keys(metaFiles),
  );
}

// Get all lessons for this course
const allLessons = await getCollection('lessons', ({ id, data }) => {
  // Filter lessons that belong to this course (id starts with courseSlug)
  // Exclude index.mdx files (they belong to courses collection)
  return (
    id.startsWith(courseSlug) &&
    !id.endsWith('/index') &&
    data.status === 'published'
  );
});

// Create a map of lesson slugs to lesson entries
const lessonMap = new Map();
allLessons.forEach((lesson) => {
  const lessonSlug = lesson.id.split('/').pop() || '';
  lessonMap.set(lessonSlug, lesson);
});

// Organize lessons according to meta.json structure
const sections: LessonSection[] = [];
let currentSection: LessonSection | undefined = undefined;

if (courseStructure && courseStructure.pages) {
  for (const item of courseStructure.pages) {
    if (item.startsWith('---') && item.endsWith('---')) {
      // This is a section header
      if (currentSection) {
        sections.push(currentSection);
      }
      currentSection = {
        title: item.replace(/---/g, '').trim(),
        lessons: [],
      };
    } else if (item !== 'index' && currentSection) {
      // This is a lesson
      const lessonEntry = lessonMap.get(item);
      if (lessonEntry) {
        currentSection.lessons.push({
          slug: item,
          title: lessonEntry.data.title || item,
          entry: lessonEntry,
        });
      }
    }
  }
  if (currentSection) {
    sections.push(currentSection);
  }
}

const pageTitle = `${course.data.title} - কোর্স`;
const pageDescription = course.data.description;
---

<DefaultLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <CourseOverview
    course={course}
    sections={sections}
    courseSlug={courseSlug}
    client:load
  />
</DefaultLayout>
